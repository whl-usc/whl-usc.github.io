<!DOCTYPE html>
<html lang="en-US">
<head>
    <!-- Meta tags, CSS links, and other head content here -->
    <title>CRIS Database</title>
    <link rel="icon" type="image/png" href="/cris/images/logo_icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="CRIS: Crosslinking-based RNA Interactomes and Structurome, a comprehensive database for data, scripts, and knowledge of RNA.">
    <meta name="author" content="https://zhipenglulab.org/">
    <meta name="keywords" content="RNA, PARIS, XLRNA, SHARC">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    <!-- JavaScript functions -->
    <script src="functions.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>

<body>
    <div id="navigation-container"></div>
    <main>
        <div class="section-color">
        <h1>SHARCLIP</h1><hr />
        <h2>Supplementary Data</h2>
            <p>Supplementary Data S1-7</p>

            <div class="table-container">
            <table id="sharclip-data-table" class="table table-sm table-striped">
                <thead>
                <tr>
                    <th>Dataset</th>
                    <th>File name</th>
                    <th>Description</th>
                </tr>
                </thead>
                <tbody>
                <tr><td>Data S1</td><td>
                    DGdiv_counts.bb
                    <!--
                    <a href="" target="_blank" rel="noopener">
                        DGdiv_counts.bb
                    </a>
                    -->
                    <i class="bi bi-download text-muted ml-2"
                        title="Download (coming soon)"
                        style="cursor:not-allowed;"></i>
                </td><td>DG counts for individual samples</td></tr>
                <tr><td>Data S2</td><td>
                    A3SS_blockers.txt
                    <!--
                    <a href="https://drive.google.com/file/d/113X5EOa66KkIna9_MhwIARa60U1wUktV/view?usp=drive_link" target="_blank" rel="noopener">
                        A3SS_blockers.txt
                    </a>
                    -->
                    <i class="bi bi-download text-muted ml-2"
                        title="Download (coming soon)"
                        style="cursor:not-allowed;"></i>
                </td><td>A3SS blockers</td></tr>
                <tr><td>Data S3</td><td>
                    A5SS_blockers.txt
                    <!--
                    <a href="https://drive.google.com/file/d/1owHweg_B_YmtuR3gh1o584UFECHT5LFT/view?usp=drive_link" target="_blank" rel="noopener">
                        A5SS_blockers.txt
                    </a>
                    -->
                    <i class="bi bi-download text-muted ml-2"
                        title="Download (coming soon)"
                        style="cursor:not-allowed;"></i>
                </td><td>A5SS blockers</td></tr>
                <tr><td>Data S4</td><td>
                    RI_blockers.txt
                    <!--
                    <a href="https://drive.google.com/file/d/1Pj45F8oyVuqEzFdDjhlvNB5Izj2-BKYo/view?usp=drive_link" target="_blank" rel="noopener">
                        RI_blockers.txt
                    </a>
                    -->
                    <i class="bi bi-download text-muted ml-2"
                        title="Download (coming soon)"
                        style="cursor:not-allowed;"></i>
                </td><td>RI blockers</td></tr>
                <tr><td>Data S5</td><td>
                    SE_blockers.txt
                    <!--
                    <a href="" target="_blank" rel="noopener">
                        SE_blockers.txt
                    </a>
                    -->
                    <i class="bi bi-download text-muted ml-2"
                        title="Download (coming soon)"
                        style="cursor:not-allowed;"></i>
                </td><td>SE blockers</td></tr>
                <tr><td>Data S6</td>
                    <td>
                    Alternative_blocker_switches_for_138_MXEs.txt
                    <!--
                    <a href="https://drive.google.com/file/d/1erQLd_Ot190k5cYq80LjtLF0-u7LIHwe/view?usp=drive_link" target="_blank" rel="noopener">
                        Alternative_blocker_switches_for_138_MXEs.txt
                    </a>
                    -->
                    <i class="bi bi-download text-muted ml-2"
                        title="Download (coming soon)"
                        style="cursor:not-allowed;"></i>
                </td><td>Alternative blocker switches</td></tr>
                <tr><td>Data S7</td><td>
                    Alternative_loop_switches_for_138_MXEs.txt
                    <!--
                    <a href="https://drive.google.com/file/d/1kGjjY_psJ78i9d_mP9qiNTvqJFoUIZgu/view?usp=drive_link" target="_blank" rel="noopener">
                        Alternative_loop_switches_for_138_MXEs.txt
                    </a>
                    -->
                    <i class="bi bi-download text-muted ml-2"
                        title="Download (coming soon)"
                        style="cursor:not-allowed;"></i>
                </td><td>Alternative loop switches</td></tr>
                </tbody>
            </table>
            </div><br />


        
        <div class="dot-container"><div class="separator-dots">&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;</div></div>
    </main>
    <div id="footer-container"></div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const sel = $('file-selector');
  const showBtn = $('btn-show');
  const previewBtn = $('btn-preview');
  const uploadBtn = $('btn-upload');
  const selectionList = $('selection-list');
  const previewDiv = $('file-preview');
  const globalStatus = $('global-status');
  const resultsDiv = $('upload-results');

  function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

  showBtn.addEventListener('click', () => {
    const files = Array.from(sel.files || []);
    if (files.length === 0) {
      selectionList.innerHTML = '<div class="text-muted small">No files selected.</div>';
      return;
    }
    selectionList.innerHTML = files.map((f,i) => `<div><strong>${i+1}.</strong> ${esc(f.name)} - ${f.size.toLocaleString()} bytes</div>`).join('');
  });

  // Preview the first selected file (read as text; limit size)
  previewBtn.addEventListener('click', () => {
    previewDiv.textContent = '';
    globalStatus.textContent = '';
    const file = (sel.files && sel.files[0]) || null;
    if (!file) { globalStatus.textContent = 'No file selected to preview.'; return; }
    if (file.size > 20 * 1024 * 1024) { globalStatus.textContent = 'File too large to preview (>20MB).'; return; }

    globalStatus.textContent = 'Reading file...';
    const reader = new FileReader();
    reader.onload = (ev) => {
      const text = ev.target.result;
      const lines = text.split(/\r?\n/);
      previewDiv.textContent = lines.slice(0,200).join('\n') + (lines.length > 200 ? '\n\n... (truncated)' : '');
      globalStatus.textContent = `Preview ready - ${lines.length} lines (showing up to 200).`;
    };
    reader.onerror = () => { globalStatus.textContent = 'Could not read file.'; };
    reader.readAsText(file);
  });

  // Upload selected files sequentially
  uploadBtn.addEventListener('click', async () => {
    resultsDiv.innerHTML = '';
    globalStatus.textContent = '';
    const files = Array.from(sel.files || []);
    if (files.length === 0) { globalStatus.textContent = 'No files selected to upload.'; return; }

    globalStatus.textContent = 'Starting uploads...';
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const container = document.createElement('div');
      container.className = 'mb-2';
      container.innerHTML = `<div><strong>Uploading:</strong> ${esc(file.name)} <span id="stat-${i}" class="text-muted"></span></div>
        <div class="progress" style="height:10px;"><div id="bar-${i}" class="progress-bar" role="progressbar" style="width:0%"></div></div>
        <div id="res-${i}" class="small mt-1"></div>`;
      resultsDiv.appendChild(container);

      try {
        await uploadSingle(file, i);
        document.getElementById('stat-' + i).textContent = ' - done';
      } catch (err) {
        document.getElementById('stat-' + i).textContent = ' - failed';
        document.getElementById('res-' + i).textContent = 'Error: ' + err.message;
      }
    }
    globalStatus.textContent = 'Uploads finished (attempted).';
  });

  // single file upload using XMLHttpRequest to report progress
  function uploadSingle(file, index){
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      // <-- change this URL if the backend uses a different endpoint -->
      xhr.open('POST', '/api/upload-file', true);

      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const pct = Math.round((e.loaded / e.total) * 100);
          const bar = document.getElementById('bar-' + index);
          if (bar) bar.style.width = pct + '%';
        }
      });

      xhr.onreadystatechange = function() {
        if (xhr.readyState !== 4) return;
        const resEl = document.getElementById('res-' + index);
        if (xhr.status >= 200 && xhr.status < 300) {
          let json = null;
          try { json = JSON.parse(xhr.responseText); } catch(e){}
          resEl.innerHTML = '<span class="text-success">Success</span>' + (json ? (' - ' + esc(JSON.stringify(json))) : '');
          resolve(json);
        } else {
          resEl.innerHTML = '<span class="text-danger">Failed</span> - ' + esc(xhr.responseText || xhr.statusText || ('Status ' + xhr.status));
          reject(new Error(xhr.responseText || xhr.statusText || 'Status ' + xhr.status));
        }
      };

      const fd = new FormData();
      const sentName = file.name.replace(/\s+/g,'_');
      fd.append('file', file, sentName);

      xhr.send(fd);
    });
  }

  // initial placeholder
  selectionList.innerHTML = '<div class="text-muted small">No files selected.</div>';
})();
</script>

</body>
</html>
